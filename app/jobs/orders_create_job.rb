class OrdersCreateJob < ActiveJob::Base
  attr_accessor :webhook, :landing_site, :utm_source, :utm_medium, :utm_campaign, :campaign, :shop

  def perform(shop_domain:, webhook:)
    @webhook = webhook
    @shop = Shop.find_by(shopify_domain: shop_domain)
    if shop.nil?
      logger.error("#{self.class} failed: cannot find shop with domain '#{shop_domain}'")
      return
    end

    shop.with_shopify_session do
      @landing_site = ShopifyAPI::Order.find(webhook.id, fields: 'landing_site')
    end
    return unless source_verified?

    @campaign = shop.campaigns.find_by(name: utm_campaign)

    shop.orders.create(campaign_id: campaign&.id, landing_site: landing_site, total: webhook.total_line_items_price, name: webhook.name)
  end

  def source_verified?
    return false unless landing_site.include? "utm_source=aplicatify"
    h = extract_parameters_from_url(landing_site)
    @utm_medium, @utm_campaign = h[:utm_medium],  h[:utm_campaign]
    true
  end

  def extract_parameters_from_url(url)
    uri = URI.parse(url)
    return Rack::Utils.parse_nested_query(uri.query)
  end

end


[OrdersCreateJob] [4609ec21-3c23-493f-9897-9edef2fa06df] Performing OrdersCreateJob (Job ID: 4609ec21-3c23-493f-9897-9edef2fa06df) from Sidekiq(default) enqueued at 2020-06-08T01:11:29Z with arguments: {:shop_domain=>"teste-giovanna.myshopify.com", :webhook=>{"id"=>2298839728263, "email"=>"felipesensbonetto@gmail.com", "closed_at"=>nil, "created_at"=>"2020-06-07T21:11:26-04:00", "updated_at"=>"2020-06-07T21:11:27-04:00", "number"=>3, "note"=>nil, "token"=>"2864b58d57429c17519999177ea56be0", "gateway"=>"bogus", "test"=>true, "total_price"=>"15.21", "subtotal_price"=>"13.00", "total_weight"=>100000, "total_tax"=>"2.21", "taxes_included"=>false, "currency"=>"BRL", "financial_status"=>"authorized", "confirmed"=>true, "total_discounts"=>"0.00", "total_line_items_price"=>"13.00", "cart_token"=>"", "buyer_accepts_marketing"=>false, "name"=>"#1003", "referring_site"=>"https://teste-giovanna.myshopify.com/products/camiseta?utm_campaign=Teste+Order&utm_medium=push&utm_source=aplicatify", "landing_site"=>"/wallets/checkouts.json", "cancelled_at"=>nil, "cancel_reason"=>nil, "total_price_usd"=>"3.06", "checkout_token"=>"34deb8238a128ea2153f5730fde115ea", "reference"=>nil, "user_id"=>nil, "location_id"=>nil, "source_identifier"=>nil, "source_url"=>nil, "processed_at"=>"2020-06-07T21:11:26-04:00", "device_id"=>nil, "phone"=>nil, "customer_locale"=>"pt-BR", "app_id"=>580111, "browser_ip"=>"191.191.91.205", "landing_site_ref"=>nil, "order_number"=>1003, "discount_applications"=>[], "discount_codes"=>[], "note_attributes"=>[], "payment_gateway_names"=>["bogus"], "processing_method"=>"direct", "checkout_id"=>12960930922631, "source_name"=>"web", "fulfillment_status"=>nil, "tax_lines"=>[{"price"=>"2.21", "rate"=>0.17, "title"=>"VAT", "price_set"=>{"shop_money"=>{"amount"=>"2.21", "currency_code"=>"BRL"}, "presentment_money"=>{"amount"=>"2.21", "currency_code"=>"BRL"}}}], "tags"=>"", "contact_email"=>"felipesensbonetto@gmail.com", "order_status_url"=>"https://teste-giovanna.myshopify.com/36804657287/orders/2864b58d57429c17519999177ea56be0/authenticate?key=f77cfcdc4ba330deff2a7cc1e5165b8d", "presentment_currency"=>"BRL", "total_line_items_price_set"=>{"shop_money"=>{"amount"=>"13.00", "currency_code"=>"BRL"}, "presentment_money"=>{"amount"=>"13.00", "currency_code"=>"BRL"}}, "total_discounts_set"=>{"shop_money"=>{"amount"=>"0.00", "currency_code"=>"BRL"}, "presentment_money"=>{"amount"=>"0.00", "currency_code"=>"BRL"}}, "total_shipping_price_set"=>{"shop_money"=>{"amount"=>"0.00", "currency_code"=>"BRL"}, "presentment_money"=>{"amount"=>"0.00", "currency_code"=>"BRL"}}, "subtotal_price_set"=>{"shop_money"=>{"amount"=>"13.00", "currency_code"=>"BRL"}, "presentment_money"=>{"amount"=>"13.00", "currency_code"=>"BRL"}}, "total_price_set"=>{"shop_money"=>{"amount"=>"15.21", "currency_code"=>"BRL"}, "presentment_money"=>{"amount"=>"15.21", "currency_code"=>"BRL"}}, "total_tax_set"=>{"shop_money"=>{"amount"=>"2.21", "currency_code"=>"BRL"}, "presentment_money"=>{"amount"=>"2.21", "currency_code"=>"BRL"}}, "line_items"=>[{"id"=>5014597795975, "variant_id"=>33502107336839, "title"=>"CAmiseta", "quantity"=>1, "sku"=>"1", "variant_title"=>"", "vendor"=>"Teste Giovanna", "fulfillment_service"=>"manual", "product_id"=>4806096846983, "requires_shipping"=>true, "taxable"=>true, "gift_card"=>false, "name"=>"CAmiseta", "variant_inventory_management"=>"shopify", "properties"=>[], "product_exists"=>true, "fulfillable_quantity"=>1, "grams"=>100000, "price"=>"13.00", "total_discount"=>"0.00", "fulfillment_status"=>nil, "price_set"=>{"shop_money"=>{"amount"=>"13.00", "currency_code"=>"BRL"}, "presentment_money"=>{"amount"=>"13.00", "currency_code"=>"BRL"}}, "total_discount_set"=>{"shop_money"=>{"amount"=>"0.00", "currency_code"=>"BRL"}, "presentment_money"=>{"amount"=>"0.00", "currency_code"=>"BRL"}}, "discount_allocations"=>[], "duties"=>[], "admin_graphql_api_id"=>"gid://shopify/LineItem/5014597795975", "tax_lines"=>[{"title"=>"VAT", "price"=>"2.21", "rate"=>0.17, "price_set"=>{"shop_money"=>{"amount"=>"2.21", "currency_code"=>"BRL"}, "presentment_money"=>{"amount"=>"2.21", "currency_code"=>"BRL"}}}], "origin_location"=>{"id"=>1819041562759, "country_code"=>"BR", "province_code"=>"SC", "name"=>"Teste Giovanna", "address1"=>"RUA CLODORICO MOREIRA 53 CASA", "address2"=>"", "city"=>"Florianópolis", "zip"=>"88035012"}}], "fulfillments"=>[], "refunds"=>[], "total_tip_received"=>"0.0", "original_total_duties_set"=>nil, "current_total_duties_set"=>nil, "admin_graphql_api_id"=>"gid://shopify/Order/2298839728263", "shipping_lines"=>[{"id"=>1841848975495, "title"=>"Standard", "price"=>"0.00", "code"=>"Standard", "source"=>"shopify", "phone"=>nil, "requested_fulfillment_service_id"=>nil, "delivery_category"=>nil, "carrier_identifier"=>nil, "discounted_price"=>"0.00", "price_set"=>{"shop_money"=>{"amount"=>"0.00", "currency_code"=>"BRL"}, "presentment_money"=>{"amount"=>"0.00", "currency_code"=>"BRL"}}, "discounted_price_set"=>{"shop_money"=>{"amount"=>"0.00", "currency_code"=>"BRL"}, "presentment_money"=>{"amount"=>"0.00", "currency_code"=>"BRL"}}, "discount_allocations"=>[], "tax_lines"=>[]}], "billing_address"=>{"first_name"=>"Felipe", "address1"=>"Rua Clodorico Moreira", "phone"=>nil, "city"=>"Florianópolis", "zip"=>"88035012", "province"=>"Santa Catarina", "country"=>"Brazil", "last_name"=>"Bonetto", "address2"=>"53", "company"=>nil, "latitude"=>-27.5906878, "longitude"=>-48.5137315, "name"=>"Felipe Bonetto", "country_code"=>"BR", "province_code"=>"SC"}, "shipping_address"=>{"first_name"=>"Felipe", "address1"=>"Rua Clodorico Moreira", "phone"=>nil, "city"=>"Florianópolis", "zip"=>"88035012", "province"=>"Santa Catarina", "country"=>"Brazil", "last_name"=>"Bonetto", "address2"=>"53", "company"=>nil, "latitude"=>-27.5906878, "longitude"=>-48.5137315, "name"=>"Felipe Bonetto", "country_code"=>"BR", "province_code"=>"SC"}, "client_details"=>{"browser_ip"=>"191.191.91.205", "accept_language"=>"pt-BR,pt;q=0.9,en-US;q=0.8,en;q=0.7,gl;q=0.6,ca;q=0.5", "user_agent"=>"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_4) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.97 Safari/537.36", "session_hash"=>nil, "browser_width"=>1440, "browser_height"=>789}, "payment_details"=>{"credit_card_bin"=>"1", "avs_result_code"=>nil, "cvv_result_code"=>nil, "credit_card_number"=>"•••• •••• •••• 1", "credit_card_company"=>"Bogus"}, "customer"=>{"id"=>3145701720199, "email"=>"felipesensbonetto@gmail.com", "accepts_marketing"=>false, "created_at"=>"2020-03-29T19:30:18-04:00", "updated_at"=>"2020-06-07T21:11:27-04:00", "first_name"=>"Felipe", "last_name"=>"Bonetto", "orders_count"=>1, "state"=>"disabled", "total_spent"=>"15.21", "last_order_id"=>2102995943559, "note"=>nil, "verified_email"=>true, "multipass_identifier"=>nil, "tax_exempt"=>false, "phone"=>nil, "tags"=>"", "last_order_name"=>"#1001", "currency"=>"BRL", "accepts_marketing_updated_at"=>"2020-03-29T19:30:18-04:00", "marketing_opt_in_level"=>nil, "admin_graphql_api_id"=>"gid://shopify/Customer/3145701720199", "default_address"=>{"id"=>3572398882951, "customer_id"=>3145701720199, "first_name"=>"Felipe", "last_name"=>"Bonetto", "company"=>nil, "address1"=>"Rua Clodorico Moreira", "address2"=>"53", "city"=>"Florianópolis", "province"=>"Santa Catarina", "country"=>"Brazil", "zip"=>"88035012", "phone"=>nil, "name"=>"Felipe Bonetto", "province_code"=>"SC", "country_code"=>"BR", "country_name"=>"Brazil", "default"=>true}}, "webhook"=>{"id"=>2298839728263, "email"=>"felipesensbonetto@gmail.com", "closed_at"=>nil, "created_at"=>"2020-06-07T21:11:26-04:00", "updated_at"=>"2020-06-07T21:11:27-04:00", "number"=>3, "note"=>nil, "token"=>"2864b58d57429c17519999177ea56be0", "gateway"=>"bogus", "test"=>true, "total_price"=>"15.21", "subtotal_price"=>"13.00", "total_weight"=>100000, "total_tax"=>"2.21", "taxes_included"=>false, "currency"=>"BRL", "financial_status"=>"authorized", "confirmed"=>true, "total_discounts"=>"0.00", "total_line_items_price"=>"13.00", "cart_token"=>"", "buyer_accepts_marketing"=>false, "name"=>"#1003", "referring_site"=>"https://teste-giovanna.myshopify.com/products/camiseta?utm_campaign=Teste+Order&utm_medium=push&utm_source=aplicatify", "landing_site"=>"/wallets/checkouts.json", "cancelled_at"=>nil, "cancel_reason"=>nil, "total_price_usd"=>"3.06", "checkout_token"=>"34deb8238a128ea2153f5730fde115ea", "reference"=>nil, "user_id"=>nil, "location_id"=>nil, "source_identifier"=>nil, "source_url"=>nil, "processed_at"=>"2020-06-07T21:11:26-04:00", "device_id"=>nil, "phone"=>nil, "customer_locale"=>"pt-BR", "app_id"=>580111, "browser_ip"=>"191.191.91.205", "landing_site_ref"=>nil, "order_number"=>1003, "discount_applications"=>[], "discount_codes"=>[], "note_attributes"=>[], "payment_gateway_names"=>["bogus"], "processing_method"=>"direct", "checkout_id"=>12960930922631, "source_name"=>"web", "fulfillment_status"=>nil, "tax_lines"=>[{"price"=>"2.21", "rate"=>0.17, "title"=>"VAT", "price_set"=>{"shop_money"=>{"amount"=>"2.21", "currency_code"=>"BRL"}, "presentment_money"=>{"amount"=>"2.21", "currency_code"=>"BRL"}}}], "tags"=>"", "contact_email"=>"felipesensbonetto@gmail.com", "order_status_url"=>"https://teste-giovanna.myshopify.com/36804657287/orders/2864b58d57429c17519999177ea56be0/authenticate?key=f77cfcdc4ba330deff2a7cc1e5165b8d", "presentment_currency"=>"BRL", "total_line_items_price_set"=>{"shop_money"=>{"amount"=>"13.00", "currency_code"=>"BRL"}, "presentment_money"=>{"amount"=>"13.00", "currency_code"=>"BRL"}}, "total_discounts_set"=>{"shop_money"=>{"amount"=>"0.00", "currency_code"=>"BRL"}, "presentment_money"=>{"amount"=>"0.00", "currency_code"=>"BRL"}}, "total_shipping_price_set"=>{"shop_money"=>{"amount"=>"0.00", "currency_code"=>"BRL"}, "presentment_money"=>{"amount"=>"0.00", "currency_code"=>"BRL"}}, "subtotal_price_set"=>{"shop_money"=>{"amount"=>"13.00", "currency_code"=>"BRL"}, "presentment_money"=>{"amount"=>"13.00",
2020-06-08T01:14:47.016460+00:00 app[worker.1]: "currency_code"=>"BRL"}}, "total_price_set"=>{"shop_money"=>{"amount"=>"15.21", "currency_code"=>"BRL"}, "presentment_money"=>{"amount"=>"15.21", "currency_code"=>"BRL"}}, "total_tax_set"=>{"shop_money"=>{"amount"=>"2.21", "currency_code"=>"BRL"}, "presentment_money"=>{"amount"=>"2.21", "currency_code"=>"BRL"}}, "line_items"=>[{"id"=>5014597795975, "variant_id"=>33502107336839, "title"=>"CAmiseta", "quantity"=>1, "sku"=>"1", "variant_title"=>"", "vendor"=>"Teste Giovanna", "fulfillment_service"=>"manual", "product_id"=>4806096846983, "requires_shipping"=>true, "taxable"=>true, "gift_card"=>false, "name"=>"CAmiseta", "variant_inventory_management"=>"shopify", "properties"=>[], "product_exists"=>true, "fulfillable_quantity"=>1, "grams"=>100000, "price"=>"13.00", "total_discount"=>"0.00", "fulfillment_status"=>nil, "price_set"=>{"shop_money"=>{"amount"=>"13.00", "currency_code"=>"BRL"}, "presentment_money"=>{"amount"=>"13.00", "currency_code"=>"BRL"}}, "total_discount_set"=>{"shop_money"=>{"amount"=>"0.00", "currency_code"=>"BRL"}, "presentment_money"=>{"amount"=>"0.00", "currency_code"=>"BRL"}}, "discount_allocations"=>[], "duties"=>[], "admin_graphql_api_id"=>"gid://shopify/LineItem/5014597795975", "tax_lines"=>[{"title"=>"VAT", "price"=>"2.21", "rate"=>0.17, "price_set"=>{"shop_money"=>{"amount"=>"2.21", "currency_code"=>"BRL"}, "presentment_money"=>{"amount"=>"2.21", "currency_code"=>"BRL"}}}], "origin_location"=>{"id"=>1819041562759, "country_code"=>"BR", "province_code"=>"SC", "name"=>"Teste Giovanna", "address1"=>"RUA CLODORICO MOREIRA 53 CASA", "address2"=>"", "city"=>"Florianópolis", "zip"=>"88035012"}}], "fulfillments"=>[], "refunds"=>[], "total_tip_received"=>"0.0", "original_total_duties_set"=>nil, "current_total_duties_set"=>nil, "admin_graphql_api_id"=>"gid://shopify/Order/2298839728263", "shipping_lines"=>[{"id"=>1841848975495, "title"=>"Standard", "price"=>"0.00", "code"=>"Standard", "source"=>"shopify", "phone"=>nil, "requested_fulfillment_service_id"=>nil, "delivery_category"=>nil, "carrier_identifier"=>nil, "discounted_price"=>"0.00", "price_set"=>{"shop_money"=>{"amount"=>"0.00", "currency_code"=>"BRL"}, "presentment_money"=>{"amount"=>"0.00", "currency_code"=>"BRL"}}, "discounted_price_set"=>{"shop_money"=>{"amount"=>"0.00", "currency_code"=>"BRL"}, "presentment_money"=>{"amount"=>"0.00", "currency_code"=>"BRL"}}, "discount_allocations"=>[], "tax_lines"=>[]}], "billing_address"=>{"first_name"=>"Felipe", "address1"=>"Rua Clodorico Moreira", "phone"=>nil, "city"=>"Florianópolis", "zip"=>"88035012", "province"=>"Santa Catarina", "country"=>"Brazil", "last_name"=>"Bonetto", "address2"=>"53", "company"=>nil, "latitude"=>-27.5906878, "longitude"=>-48.5137315, "name"=>"Felipe Bonetto", "country_code"=>"BR", "province_code"=>"SC"}, "shipping_address"=>{"first_name"=>"Felipe", "address1"=>"Rua Clodorico Moreira", "phone"=>nil, "city"=>"Florianópolis", "zip"=>"88035012", "province"=>"Santa Catarina", "country"=>"Brazil", "last_name"=>"Bonetto", "address2"=>"53", "company"=>nil, "latitude"=>-27.5906878, "longitude"=>-48.5137315, "name"=>"Felipe Bonetto", "country_code"=>"BR", "province_code"=>"SC"}, "client_details"=>{"browser_ip"=>"191.191.91.205", "accept_language"=>"pt-BR,pt;q=0.9,en-US;q=0.8,en;q=0.7,gl;q=0.6,ca;q=0.5", "user_agent"=>"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_4) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.97 Safari/537.36", "session_hash"=>nil, "browser_width"=>1440, "browser_height"=>789}, "payment_details"=>{"credit_card_bin"=>"1", "avs_result_code"=>nil, "cvv_result_code"=>nil, "credit_card_number"=>"•••• •••• •••• 1", "credit_card_company"=>"Bogus"}, "customer"=>{"id"=>3145701720199, "email"=>"felipesensbonetto@gmail.com", "accepts_marketing"=>false, "created_at"=>"2020-03-29T19:30:18-04:00", "updated_at"=>"2020-06-07T21:11:27-04:00", "first_name"=>"Felipe", "last_name"=>"Bonetto", "orders_count"=>1, "state"=>"disabled", "total_spent"=>"15.21", "last_order_id"=>2102995943559, "note"=>nil, "verified_email"=>true, "multipass_identifier"=>nil, "tax_exempt"=>false, "phone"=>nil, "tags"=>"", "last_order_name"=>"#1001", "currency"=>"BRL", "accepts_marketing_updated_at"=>"2020-03-29T19:30:18-04:00", "marketing_opt_in_level"=>nil, "admin_graphql_api_id"=>"gid://shopify/Customer/3145701720199", "default_address"=>{"id"=>3572398882951, "customer_id"=>3145701720199, "first_name"=>"Felipe", "last_name"=>"Bonetto", "company"=>nil, "address1"=>"Rua Clodorico Moreira", "address2"=>"53", "city"=>"Florianópolis", "province"=>"Santa Catarina", "country"=>"Brazil", "zip"=>"88035012", "phone"=>nil, "name"=>"Felipe Bonetto", "province_code"=>"SC", "country_code"=>"BR", "country_name"=>"Brazil", "default"=>true}}}}}